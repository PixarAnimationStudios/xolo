#!/bin/zsh


# constants

SIGNING_ID="Developer ID Installer: Pixar Animation Studios (F3G5LR2F93)"

PKG_ID="com.pixar.xolo.xadm"

PILOT_GROUP="xadm-piloters"

# vars

xadm_dir="$(dirname "$0")"

xolo_src_dir="$xadm_dir/../.."

xolo_version=$(ruby -r $xolo_src_dir/lib/xolo/core/version.rb -e 'puts Xolo::Core::Version::VERSION')

pkg_root="$xadm_dir/pkgroot"

root_tmp_dir="$pkg_root/private/tmp"

pkg_scripts_dir="$xadm_dir/install-scripts"

component_pkg="$xadm_dir/xadm.pkg"

dist_pkg="$xadm_dir/xadm-dist.pkg"

echo "Building the xadm package for version $xolo_version and adding it to the xadm title for piloting"

# copy the new one into the tmp dir of the pkg root
# NOTE: the highline gem is already there
echo "Copying the xolo gem to the tmp dir of the pkg root"
cp "$xolo_src_dir"/xolo-*.gem "$root_tmp_dir" || exit 1

# remove any finder crap from the pkg root
echo "Removing any Finder metadata from the pkg root"
find "$pkg_root" -name .DS_Store -delete

# ensure pkg scripts are executable
echo "Ensuring install scripts are executable"
chmod +x "$pkg_scripts_dir"/*

# build the component package
echo "Building the component package"
pkgbuild --root "$pkg_root" \
  --identifier "$PKG_ID" \
  --version $xolo_version \
  --sign "$SIGNING_ID" \
  --scripts "$pkg_scripts_dir" \
  --install-location / \
  "$component_pkg" || exit 1

# build the distribution package
echo "Building the distribution package"
productbuild --package "$component_pkg" \
  --identifier "$PKG_ID" \
  --version $xolo_version \
  --sign "$SIGNING_ID" \
  "$dist_pkg" || exit 1

# add the version
echo "Adding the new version to xadm"
xadm --proxy-admin "$GITLAB_USER_LOGIN" --auto-confirm --debug add-version xadm $xolo_version \
   --standalone \
   --pkg-to-upload "$dist_pkg"  \
   --publish-date "$(date +'%F %T')" \
   --min-os 13.0 \
   --pilot-groups "$PILOT_GROUP"

  echo "+++>>>>  xadm exited with status $?"

echo "Done building and adding the xadm package to the xadm title for piloting."