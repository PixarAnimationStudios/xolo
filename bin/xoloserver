#!/usr/local/pixar/ruby/bin/ruby

# TEMP
ENV['GEM_PATH'] = "/usr/local/pixar/ruby/aliases/default/lib/ruby/gems:#{ENV['GEM_PATH']}"
require 'pixenv'

# !/usr/bin/env ruby

# Copyright 2024 Pixar
#
#    Licensed under the Apache License, Version 2.0 (the "Apache License")
#    with the following modification; you may not use this file except in
#    compliance with the Apache License and the following modification to it:
#    Section 6. Trademarks. is deleted and replaced with:
#
#    6. Trademarks. This License does not grant permission to use the trade
#       names, trademarks, service marks, or product names of the Licensor
#       and its affiliates, except as required to comply with Section 4(c) of
#       the License and to reproduce the content of the NOTICE file.
#
#    You may obtain a copy of the Apache License at
#
#        http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the Apache License with the above modification is
#    distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#    KIND, either express or implied. See the Apache License for the specific
#    language governing permissions and limitations under the Apache License.
#

# frozen_string_literal: true

require 'xolo-server'

# The Server Wrapper App
#####################
class XoloServer

  include Xolo::Core::Output

  def initialize
    # CLI
    Xolo::Server.parse_cli
    Xolo::Server.debug = Xolo::Server.cli_opts[:debug]
    Xolo::Server.app_env = Xolo::Server.cli_opts[:production] ? Xolo::Server::APP_ENV_PROD : Xolo::Server::APP_ENV_DEV
  end

  def run
    Process.setproctitle Xolo::Server::EXECUTABLE_FILENAME

    # TESTING
    # puts '##############################'
    # puts Gem.ruby
    # Xolo::Server.config.to_h.each { |k, v| puts "#{k} =>\n  #{v}" }
    # puts '##############################'

    if Xolo::Server.config_opts.to_h.empty?
      Xolo::Server::App.run!

    elsif Xolo::Server.config_opts[:show]
      Xolo::Server.config.to_h_private.each { |k, v| puts "#{k}: #{v}" }

    end
  end # run

  #########
  def show_config_help
    text = +<<~TEXT
        Xolo Server Configuration Options
        #################################

        The Xolo server configuration file is a YAML file located at
        #{Xolo::Server.config.conf_file}.
        It contains a Ruby Hash of configuration options, the keys are
        Symbols and the values are the configuration values.

        Those marked Private are not shown in when the config values are displayed.

        Below are the configuration keys and their descriptions.
        #################################

    TEXT

    Xolo::Server::Configuration::KEYS.each do |key, deets|
      text << "Hash Key: #{key}:\n"
      text << "  Default: #{deets[:default]}\n" if deets[:default]
      text << "  Required: #{deets[:required]}\n" if deets[:required]
      text << "  Private: #{deets[:private]}\n" if deets[:private]
      text << "Description: \n"
      text << "#{deets[:desc]}\n"
      text << "---------------------------------\n\n"
    end
    show_text text
  end

end # class XoloServer

# MAIN
#####################
begin
  app = XoloServer.new
  app.run
rescue => e
  warn "ERROR #{e.class}: #{e}"
  e.backtrace.each { |l| warn "..#{l}" }
end
