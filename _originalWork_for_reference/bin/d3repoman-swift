#!/usr/bin/swift

import AppKit

// filesystem access...
let fileManager = FileManager.default

// the d3 support folder
let d3SupportFolder = "/Library/Application Support/d3"

// The folder where we collect the data per-user
// this folder needs to exist and be root:wheel, 0733
let d3UsageFolder = "\(d3SupportFolder)/Usage"

// the live plist
let plistPath = "\(d3UsageFolder)/\(NSUserName())xx.plist"

// the usage data
var monitorPlistData = NSMutableDictionary()

// if the live plist exists, load it
if fileManager.fileExists(atPath: plistPath) {
  monitorPlistData = NSMutableDictionary(contentsOfFile: plistPath)!
} else {
  monitorPlistData.write(toFile: plistPath, atomically: false)
} // if fileManager...

let plistMode: [FileAttributeKey: Any] = [.posixPermissions: 0o600]

// set the plist to mode 600, (decimal 384)
// try! fileManager.setAttributes(plistMode, ofItemAtPath: plistPath)


NSWorkspace.shared.notificationCenter.addObserver(
  forName:  NSWorkspace.didActivateApplicationNotification,
  object: nil,
  queue: nil,
  using: {(notification: Notification) -> Void  in
    let userInfo = notification.userInfo
    let runningApp: NSRunningApplication = userInfo![NSWorkspace.applicationUserInfoKey] as! NSRunningApplication
    let appExecPath = runningApp.executableURL!.path as String?
    let now = NSDate()
    let message = "Looks like \(NSUserName()) brought \(appExecPath!) forward at \(now)"
    print(message)
    // monitorPlistData[plistKey] = now
    // monitorPlistData.write(toFile: plistPath, atomically: false)
  } // usingBlock
) // addObserver

RunLoop.current.run()


// RunLoop.current.run()
